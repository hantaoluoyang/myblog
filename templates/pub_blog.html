{% extends 'base.html' %}

{% block title %}发布博客{% endblock %}

{% block head %}
    <script src="{% static 'jquery/jquery.js' %}"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet">
    <link href="https://unpkg.com/@wangeditor/editor@latest/dist/css/style.css" rel="stylesheet">
    <link href="{% static 'wangeditor/layout.css' %}" rel="stylesheet">
    <script src="{% static 'wangeditor/custom.js' %}"></script>
{% endblock %}

{% block main %}
    <h1>发布博客</h1>
    <div class="mt-3">
        <!-- onsubmit="return false;" 防止传统表单提交 -->
        <form action="" method="POST" onsubmit="return false;">
            {% csrf_token %}
            
            <div class="mt-3">
                <!-- 修复拼写错误：labe -> label -->
                <label class="form-label">标题</label>
                <input type="text" name="title" class="form-control" placeholder="请输入博客标题">
            </div>

            <div class="mt-3">
                <label class="form-label">分类</label>
                <select name="category" class="form-select">
                    <option value="">请选择分类</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <div class="mt-3">
                    <label class="form-label">内容</label>
                </div>
                <div class="page-container">
                    <div class="page-left">
                        <demo-menu></demo-menu>
                    </div>
                    <div class="page-right">
                        <!-- 编辑器 DOM -->
                        <div style="border: 1px solid #ccc;">
                            <div id="editor-toolbar" style="border-bottom: 1px solid #ccc;"></div>
                            <div id="editor-text-area" style="height: 500px"></div>
                        </div>

                        <!-- 内容状态 -->
                        <p style="background-color: #f1f1f1;">
                            Text length: <span id="total-length">0</span>；
                            Selected text length: <span id="selected-length">0</span>；
                        </p>
                    </div>
                </div>

                <script src="https://unpkg.com/@wangeditor/editor@latest/dist/index.js"></script>
                <script>
                    const E = window.wangEditor

                    // 切换语言
                    const LANG = location.href.indexOf('lang=en') > 0 ? 'en' : 'zh-CN'
                    E.i18nChangeLanguage(LANG)

                    window.editor = E.createEditor({
                        selector: '#editor-text-area',
                        html: '<p><br></p>',
                        config: {
                            placeholder: '请输入博客内容...',
                            MENU_CONF: {
                                uploadImage: {
                                    fieldName: 'your-fileName',
                                    base64LimitSize: 10 * 1024 * 1024 // 10M 以下插入 base64
                                }
                            },
                            onChange(editor) {
                                // 选中文字
                                const selectionText = editor.getSelectionText()
                                document.getElementById('selected-length').innerHTML = selectionText.length
                                // 全部文字
                                const text = editor.getText().replace(/\n|\r/mg, '')
                                document.getElementById('total-length').innerHTML = text.length
                            }
                        }
                    })

                    window.toolbar = E.createToolbar({
                        editor: window.editor,
                        selector: '#editor-toolbar',
                        config: {}
                    })
                </script>
            </div>

            <!-- 提交按钮：type="button" 防止默认提交 -->
            <div class="mb-3 text-end">
                <button type="button" class="btn btn-primary" id="submit-btn">发布</button>
            </div>

        </form>
    </div>

    <!-- 关键：引入 AJAX 处理脚本，必须在 wangEditor 初始化之后 -->
    <script src="{% static 'js/pub_blog.js' %}"></script>
{% endblock %}